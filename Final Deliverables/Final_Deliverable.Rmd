---
title: "Final Deliverable"
author: "Joe Kosteck, Ashley Klesmit, Patrick McCullough, Dan Malee"
date: "April 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Executive Summary
The City of South Bend requested an assessment of the city's current housing situation from both a rental and owner-occupied perspective.  The research team analyzed social, demographic, and economic data available from the U.S. Census as well as residential housing data sources (e.g. Zillow).  With this data, models were created to find commonalities within the data at a Census Block Group level to group them into clusters or "profiles".  The team then used these "profiles" to perform statistical and inferential analyses to illustrate similarities and differences among granular areas of the City of South Bend.  
The results shown in greater detail in this paper found five clusters of similar Census Block Groups.  These five clusters have unique and differentiating characteristics, and they span many areas of the greater South Bend area.  While some are naturally grouped in close geographic proximity, it is enlightening to see Block Groups from geographically different areas of the city and outlying areas clustered together.  This paper will explain the process used to extract the data, the methodology behind the models created to cluster the data, and the statistical analysis done on the clusters to create "profiles".

#Data Description
The primary source of data for this analysis was the American Community Survey (ACS) conducted by the US Census Bureau.  The ACS is an ongoing survey that provides vital information on an annual basis about the nation and its people.  Information from the survey generates data that helps drive federal and state funding decisions.  The data is made available via API from the US Census website, and for our analysis we used the 2017 data for St. Joseph County - which includes South Bend.
The US Census divides geographic areas into two primary categories: a Census Tract and a Census Block Group.  These are simple geographic perimeters defined by census officials.  Tracts can be made up of one or more Block Groups.  For St. Joseph County, there are a total of 76 Census Tracts and 227 Census Block Groups.  The ACS provides a vast number of variables from which we selected approximately 104 variables for our analysis.  We focused on using the Census Block Groups in our modeling as that provided more granular areas for potential clustering; however, Exploratory Data Analysis (EDA) was conducted on both Block Group and Tract data.  See Appendix A for a full list of variables used.


```{r, warning=FALSE, echo=FALSE, message=FALSE}
#First, set the working directory
setwd("~/Masters/DS Now/DS-Now-Final-Project-master/Final Deliverables")
```

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#Load the pacman library. If the pacman library is not installed, then it will be automatically installed
if(!require(pacman)) {
  install.packages("pacman")
}

library(pacman)
```

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#Use p_load to load all other needed libraries, these will be installed if not already done
p_load(tidycensus, tidyverse, leaflet, rgdal, DT, rgeos, sf, knitr, kableExtra, ggmap)

#Load the output from the cluster analysis. Also load the census shapefiles for block groups and tracts
load("cluster data for analysis.RData")
load("census_shapefiles.RData")
```

```{r, echo=FALSE, message=FALSE, results='hide'}
#Read in the neighborhood boundaries shapefile
neighborhoods <- readOGR("./South_Bend_Active_Neighborhoods_Map",
                         layer = "Neighborhood_Boundaries-polygon",
                         stringsAsFactors = F)

#Clean up weird character that appears in some names, encoding error
neighborhoods$Name <- str_remove_all(neighborhoods$Name, "Â")

#Read in the city limits data
city_limits <- readOGR("./South_Bend_Active_Neighborhoods_Map",
                       layer = "City_Limits",
                       stringsAsFactors = F)
```
#County-wide Block Group Data
The maps and data tables below show data related to all the block groups in St. Joseph's county.

##Variables Included in this Analysis
```{r, echo=FALSE}
#Make an array of names of variables used in this analysis
col_name_array <- array(c("Population",
                          "Housing Units",
                          "Occupied Housing Units",
                          "Vacant Housing Units",
                          "Owner-Occupied Units",
                          "Renter-Occupied Units",
                          "Units for Rent",
                          "Rented, Non-Occupied Units",
                          "Units for Sale",
                          "Sold, Non-Occupied Units",
                          "25th Percentile Home Value",
                          "50th Percentile Home Value",
                          "75th Percentile Home Value",
                          "Median Owner Cost - Mortgage",
                          "Median Owner Cost - No Mortgage",
                          "Median Owner Cost/Income - Mortgage",
                          "Median Owner Cost/Income - No Mortgage",
                          "Median Family Income",
                          "White Population",
                          "Black Population",
                          "Native American Population",
                          "Asian Population",
                          "Pacific Islander Population",
                          "Other Population",
                          "Two or More Races Population",
                          "Median Age",
                          "Median Age - Male",
                          "Median Age - Female",
                          "Households",
                          "Family Households",
                          "Family Households - Married",
                          "Family Households - Other",
                          "Non-family Households",
                          "Non-family Households - Alone",
                          "Non-family Households - Not Alone",
                          "Two Person Families",
                          "Three Person Families",
                          "Four Person Families",
                          "Five Person Families",
                          "Six Person Families",
                          "7 or More Person Families",
                          "1 Person Non-families",
                          "2 Person Non-families",
                          "3 Person Non-families",
                          "4 Person Non-families",
                          "5 Person Non-families",
                          "6 Person Non-families",
                          "7 or More Person Non-families",
                          "Labor Force",
                          "Civilian Labor Force",
                          "Civilian Labor Force - Employed",
                          "Civilian Labor Force - Unemployed",
                          "Military Labor Force",
                          "Non-Labor Force",
                          "Education - No Schooling",
                          "Education - Nursery School",
                          "Education - Kindergarten",
                          "Education - First Grade",
                          "Education - Second Grade",
                          "Education - Third Grade",
                          "Education - Fourth Grade",
                          "Education - Fifth Grade",
                          "Education - Sixth Grade",
                          "Education - Seventh Grade",
                          "Education - Eighth Grade",
                          "Education - Ninth Grade",
                          "Education - Tenth Grade",
                          "Education - Eleventh Grade",
                          "Education - Twelfth Grade - No Diploma",
                          "Education - High School Diploma",
                          "Education - GED or Alternative",
                          "Education - Less Than 1 Year College",
                          "Education - More Than 1 Year Collage - No Degree",
                          "Education - Associates Degree",
                          "Education - Bachelors Degree",
                          "Education - Masters Degree",
                          "Education - Professional School Degree",
                          "Education - Doctorate Degree",
                          "Commute - Car, Truck or Van",
                          "Commute - Drive Alone",
                          "Commute - Carpool",
                          "Commute - 2 Person Carpool",
                          "Commute - 3 Person Carpool",
                          "Commute - 4 Person Carpool",
                          "Commute - 5 or 6 Person Carpool",
                          "Commute - 7 or More Person Carpool",
                          "Commute - Public Transportation",
                          "Commute - Bus or Trolley",
                          "Commute - Subway or Elevated Train",
                          "Commute - Railroad Train",
                          "Commute - Ferry Boat",
                          "Commute - Taxi",
                          "Commute - Motorcycle",
                          "Commute - Bicycle",
                          "Commute - Walk",
                          "Commute - Other Means",
                          "Commute - Work from Home",
                          "Household Income - Less than $10,000",
                          "Household Income - $10,000 - $14,999",
                          "Household Income - $15,000 - $19,999",
                          "Household Income - $20,000 - $24,999",
                          "Household Income - $25,000 - $29,999",
                          "Household Income - $30,000 - $34,999",
                          "Household Income - $35,000 - $39,999",
                          "Household Income - $40,000 - $44,999",
                          "Household Income - $45,000 - $49,999",
                          "Household Income - $50,000 - $59,999",
                          "Household Income - $60,000 - $74,999",
                          "Household Income - $75,000 - $99,999",
                          "Household Income - $100,000 - $124,999",
                          "Household Income - $125,000 - $149,999",
                          "Household Income - $150,000 - $199,999",
                          "Household Income - $200,000 or More",
                          "Median Rent/Income",
                          "Median Housing Cost",
                          "Median Non-family Income",
                          "Median Rent - No Bedrooms",
                          "Median Rent - 1 Bedroom",
                          "Median Rent - 2 Bedrooms",
                          "Median Rent - 3 Bedrooms",
                          "Median Rent - 4 Bedrooms",
                          "Median Rent - 5 or More Bedrooms",
                          "Median Rent",
                          "Aggregate Income Deficit",
                          "Aggregate Income Deficit - Married",
                          "Aggregate Income Deficit - Nonmarried",
                          "Aggregate Income Deficit - No Wife",
                          "Aggregate Income Deficit - No Husband",
                          "Median Household Income",
                          "Median Household Income - Owners",
                          "Median Household Income - Renters",
                          "Commute - Streetcar or Trolley Car",
                          "Empolyed - No Vehicles Available",
                          "Empolyed - 1 Vehicle Available",
                          "Empolyed - 2 Vehicles Available",
                          "Empolyed - 3 Vehicles Available",
                          "Empolyed - 4 Vehicles Available",
                          "Empolyed - 5 Vehicles Available"), dim = c(35, 4))

#Set the last two cells of the table to blank, as there is 138 variables but 140 cells
col_name_array[34:35, 4] <- ""

#Use kable functions to create a nice looking table
kable(col_name_array, col.names = rep("", 4), row.names = F) %>%
  kable_styling()
```

##Interactive Block Group and Neighborhood Map
The map below shows the boundaries of the census Block Groups, colored by their profile. Additionally, neighborhood boundaries from the South Bend Neighborhood Resources Connection and the South Bend city limits are overlayed on the map.
```{r, echo=FALSE, warning=FALSE}
#Join the minus margins data to the shapefiles, simply to get the Profile/cluster,
#Used for coloring the map
block_shapes_profile <- block_shapes %>%
  inner_join(minus_margins_block, by = "NAME") %>%
  select(NAME, `Block Group`, `Census Tract`,
         Profile = cluster, geometry)

#Create a color pallete for the Profile colors
profile_block_pal <- colorFactor("Dark2", block_shapes$Profile)
#Get 5 colors from the pallete created above. These will be the profile colors
profile_colors <- profile_block_pal(1:5)

#Clean up the block group names by removing "Block Group ", leaving use the number
block_shapes_profile$`Block Group` <- str_remove(block_shapes_profile$`Block Group`,
                                                 "Block Group ")

#Clean up the census tract names by removing "Census Track ", leaving use the number
block_shapes_profile$`Census Tract` <- str_remove(block_shapes_profile$`Census Tract`,
                                                  "Census Tract ")

#Create an html popup for use in the interactive map. This will display the block group name and profile
block_shapes_profile$name_popup <- paste0("<b>Profile: </b>",
                                          block_shapes_profile$Profile,
                                          "<br><b>Census Tract: </b>",
                                          block_shapes_profile$`Census Tract`,
                                          "<br><b>Block Group: </b>",
                                          block_shapes_profile$`Block Group`)

#Create the map
leaflet() %>%
  addTiles() %>% #Add backgroup of South Bend
  addPolygons(data = block_shapes_profile[block_shapes_profile$Profile == 1,], #Add first layer, Profile 1
              color = profile_colors[1], #Set color to 1st color from above
              fillOpacity = .75, #Make somewhat transparent full
              opacity = 1, #Outline is dark
              popup = ~name_popup, #Set the popup
              group = "Profile 1") %>% #Create group for checkbox control
  addPolygons(data = block_shapes_profile[block_shapes_profile$Profile == 2,], #Same as above
              color = profile_colors[2],
              fillOpacity = .75,
              opacity = 1,
              popup = ~name_popup,
              group = "Profile 2") %>%
  addPolygons(data = block_shapes_profile[block_shapes_profile$Profile == 3,], #Same as above
              color = profile_colors[3],
              fillOpacity = .75,
              opacity = 1,
              popup = ~name_popup,
              group = "Profile 3") %>%
  addPolygons(data = block_shapes_profile[block_shapes_profile$Profile == 4,], #Same as above
              color = profile_colors[4],
              fillOpacity = .75,
              opacity = 1,
              popup = ~name_popup,
              group = "Profile 4") %>%
  addPolygons(data = block_shapes_profile[block_shapes_profile$Profile == 5,], #Same as above
              color = profile_colors[5],
              fillOpacity = .75,
              opacity = 1,
              popup = ~name_popup,
              group = "Profile 5") %>%
  addPolygons(data = city_limits, #Add city limits
              color = "black", #Make outline black
              fillOpacity = 0, #No fill
              opacity = 1, #Dark outline
              weight = 2, #Set size
              group = "City Limits") %>% #Add group for checkbox
  addPolygons(data = neighborhoods, #Similar to above
              color = "black",
              fillOpacity = .4, #Make somewhat transparent
              opacity = 1,
              weight = 2,
              group = "Neighborhoods",
              label = ~Name) %>% #Add neighborhood name for hover function
  addLegend(pal = profile_block_pal, #Add a legend for the profiles
            values = block_shapes_profile$Profile) %>%
  addLayersControl(overlayGroups = c("Profile 1", "Profile 2", "Profile 3",
                                     "Profile 4", "Profile 5", "Neighborhoods",
                                     "City Limits"), #add checkbox to control layers
                   options = layersControlOptions(collapsed = FALSE),
                   position = "topleft")
```

##Average Values for Each Profile
Below, the data table shows the average values of the Block Groups that are contained within each profile.
```{r, echo=FALSE}
#Transpose the centers of the block group data. Make it a more presentable for readers
transposed_center_block <- as.data.frame(t(unscaled_centers_block))

#Set the column names to represent the profiles
colnames(transposed_center_block) <- paste0("Profile ", 1:5)

#Round values for presentation
transposed_center_block <- round(transposed_center_block, 2)

#Get rid of the first row, this contains values 1-5 from being transposed
transposed_center_block <- transposed_center_block[-1, ]

#Set the row
transposed_row_names <- c("Average Population",
                          "Average Housing Units",
                          "Average Occupied Housing Units",
                          "Average Vacant Housing Units",
                          "Average Owner-Occupied Units",
                          "Average Renter-Occupied Units",
                          "Average Units for Rent",
                          "Average Rented, Non-Occupied Units",
                          "Average Units for Sale",
                          "Average Sold, Non-Occupied Units",
                          "25th Percentile Home Value",
                          "50th Percentile Home Value",
                          "75th Percentile Home Value",
                          "Median Owner Cost - Mortgage",
                          "Median Owner Cost - No Mortgage",
                          "Median Owner Cost/Income - Mortgage",
                          "Median Owner Cost/Income - No Mortgage",
                          "Median Family Income",
                          "Average White Population",
                          "Average Black Population",
                          "Average Native American Population",
                          "Average Asian Population",
                          "Average Pacific Islander Population",
                          "Average Other Population",
                          "Average Two or More Races Population",
                          "Median Age",
                          "Median Age - Male",
                          "Median Age - Female",
                          "Average Households",
                          "Family Households",
                          "Family Households - Married",
                          "Family Households - Other",
                          "Non-family Households",
                          "Non-family Households - Alone",
                          "Non-family Households - Not Alone",
                          "Two Person Families",
                          "Three Person Families",
                          "Four Person Families",
                          "Five Person Families",
                          "Six Person Families",
                          "7 or More Person Families",
                          "1 Person Non-families",
                          "2 Person Non-families",
                          "3 Person Non-families",
                          "4 Person Non-families",
                          "5 Person Non-families",
                          "6 Person Non-families",
                          "7 or More Person Non-families",
                          "Average Labor Force",
                          "Civilian Labor Force",
                          "Civilian Labor Force - Employed",
                          "Civilian Labor Force - Unemployed",
                          "Military Labor Force",
                          "Non-Labor Force",
                          "Education - No Schooling",
                          "Education - Nursery School",
                          "Education - Kindergarten",
                          "Education - First Grade",
                          "Education - Second Grade",
                          "Education - Third Grade",
                          "Education - Fourth Grade",
                          "Education - Fifth Grade",
                          "Education - Sixth Grade",
                          "Education - Seventh Grade",
                          "Education - Eighth Grade",
                          "Education - Ninth Grade",
                          "Education - Tenth Grade",
                          "Education - Eleventh Grade",
                          "Education - Twelfth Grade - No Diploma",
                          "Education - High School Diploma",
                          "Education - GED or Alternative",
                          "Education - Less Than 1 Year College",
                          "Education - More Than 1 Year Collage - No Degree",
                          "Education - Associates Degree",
                          "Education - Bachelors Degree",
                          "Education - Masters Degree",
                          "Education - Professional School Degree",
                          "Education - Doctorate Degree",
                          "Commute - Car, Truck or Van",
                          "Commute - Drive Alone",
                          "Commute - Carpool",
                          "Commute - 2 Person Carpool",
                          "Commute - 3 Person Carpool",
                          "Commute - 4 Person Carpool",
                          "Commute - 5 or 6 Person Carpool",
                          "Commute - 7 or More Person Carpool",
                          "Commute - Public Transportation",
                          "Commute - Bus or Trolley",
                          "Commute - Subway or Elevated Train",
                          "Commute - Railroad Train",
                          "Commute - Ferry Boat",
                          "Commute - Taxi",
                          "Commute - Motorcycle",
                          "Commute - Bicycle",
                          "Commute - Walk",
                          "Commute - Other Means",
                          "Commute - Work from Home",
                          "Household Income - Less than $10,000",
                          "Household Income - $10,000 - $14,999",
                          "Household Income - $15,000 - $19,999",
                          "Household Income - $20,000 - $24,999",
                          "Household Income - $25,000 - $29,999",
                          "Household Income - $30,000 - $34,999",
                          "Household Income - $35,000 - $39,999",
                          "Household Income - $40,000 - $44,999",
                          "Household Income - $45,000 - $49,999",
                          "Household Income - $50,000 - $59,999",
                          "Household Income - $60,000 - $74,999",
                          "Household Income - $75,000 - $99,999",
                          "Household Income - $100,000 - $124,999",
                          "Household Income - $125,000 - $149,999",
                          "Household Income - $150,000 - $199,999",
                          "Household Income - $200,000 or More",
                          "Median Rent/Income",
                          "Median Housing Cost",
                          "Median Non-family Income",
                          "Median Rent - No Bedrooms",
                          "Median Rent - 1 Bedroom",
                          "Median Rent - 2 Bedrooms",
                          "Median Rent - 3 Bedrooms",
                          "Median Rent - 4 Bedrooms",
                          "Median Rent - 5 or More Bedrooms",
                          "Median Rent",
                          "Aggregate Income Deficit",
                          "Aggregate Income Deficit - Married",
                          "Aggregate Income Deficit - Nonmarried",
                          "Aggregate Income Deficit - No Wife",
                          "Aggregate Income Deficit - No Husband",
                          "Median Household Income",
                          "Median Household Income - Owners",
                          "Median Household Income - Renters",
                          "Commute - Streetcar or Trolley Car",
                          "Empolyed - No Vehicles Available",
                          "Empolyed - 1 Vehicle Available",
                          "Empolyed - 2 Vehicles Available",
                          "Empolyed - 3 Vehicles Available",
                          "Empolyed - 4 Vehicles Available",
                          "Empolyed - 5 Vehicles Available")

#Set the row names
rownames(transposed_center_block) <- transposed_row_names
```

```{r, echo=FALSE}
#Use datatable to display interactive table and make it available for download
datatable(transposed_center_block,
          extensions = 'Buttons', options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)
```

##Total Values for Each Profile
Below, the data table shows the total values of the Block Groups that are contained within each profile.

```{r, warning=FALSE, echo=FALSE, message=FALSE}
#Create a data frame that has the imputed data for data that was imputed
#And the raw data for data that was not imputed

#Find the data which was not imputed, create temp dataframe containing it
total_block_data <- minus_margins_block %>%
  select(-c(colnames(imputed_block)[colnames(imputed_block) != "cluster"]))

#Split the names to join to the imputed data, make block group and census tract
total_block_data$`Block Group` <- apply(total_block_data[, 'NAME'], 1, function(x){str_split(x, pattern = ", ")[[1]][1]})
total_block_data$`Census Tract` <- apply(total_block_data[, 'NAME'], 1, function(x){str_split(x, pattern = ", ")[[1]][2]})

#Join back in the imputed data, now we have a full set
total_block_data <- imputed_block %>%
  inner_join(total_block_data, by = c("Block Group", "Census Tract", "cluster"))

#Clean up the block group names by removing "Block Group ", leaving use the number
total_block_data$`Block Group` <- str_remove(total_block_data$`Block Group`,
                                             "Block Group ")

#Clean up the census tract names by removing "Census Track ", leaving use the number
total_block_data$`Census Tract` <- str_remove(total_block_data$`Census Tract`,
                                              "Census Tract ")

#Rename 'cluster' to profile
total_block_data <- rename(total_block_data, Profile = cluster)
```

```{r, echo=FALSE}
#Create total values for each Profile. Because rates do not make sense to sum,
#They will be excluded
total_profile_values <- total_block_data %>%
  select(-contains("median"),
         -starts_with("med"),
         -starts_with("owner_hous_val")) %>%
  group_by(Profile) %>%
  select_if(is.numeric) %>%
  summarise_all(sum, na.rm = T)

#Transpose data frame, drop first row, which is just the profile number
transposed_profile_sums <- as.data.frame(t(total_profile_values))[-1, ]
#Set the column names
colnames(transposed_profile_sums) <- paste0("Profile ", 1:5)

#Set the row names
rownames(transposed_profile_sums) <- c("Total Population",
                                       "Total Housing Units",
                                       "Total Occupied Housing Units",
                                       "Total Vacant Housing Units",
                                       "Total Owner-Occupied Units",
                                       "Total Renter-Occupied Units",
                                       "Total Units for Rent",
                                       "Total Rented, Non-Occupied Units",
                                       "Total Units for Sale",
                                       "Total Sold, Non-Occupied Units",
                                       "Total White Population",
                                       "Total Black Population",
                                       "Total Native American Population",
                                       "Total Asian Population",
                                       "Total Pacific Islander Population",
                                       "Total Other Population",
                                       "Total Two or More Races Population",
                                       "Total Households",
                                       "Family Households",
                                       "Family Households - Married",
                                       "Family Households - Other",
                                       "Non-family Households",
                                       "Non-family Households - Alone",
                                       "Non-family Households - Not Alone",
                                       "Two Person Families",
                                       "Three Person Families",
                                       "Four Person Families",
                                       "Five Person Families",
                                       "Six Person Families",
                                       "7 or More Person Families",
                                       "1 Person Non-families",
                                       "2 Person Non-families",
                                       "3 Person Non-families",
                                       "4 Person Non-families",
                                       "5 Person Non-families",
                                       "6 Person Non-families",
                                       "7 or More Person Non-families",
                                       "Total Labor Force",
                                       "Civilian Labor Force",
                                       "Civilian Labor Force - Employed",
                                       "Civilian Labor Force - Unemployed",
                                       "Military Labor Force",
                                       "Non-Labor Force",
                                       "Education - No Schooling",
                                       "Education - Nursery School",
                                       "Education - Kindergarten",
                                       "Education - First Grade",
                                       "Education - Second Grade",
                                       "Education - Third Grade",
                                       "Education - Fourth Grade",
                                       "Education - Fifth Grade",
                                       "Education - Sixth Grade",
                                       "Education - Seventh Grade",
                                       "Education - Eighth Grade",
                                       "Education - Ninth Grade",
                                       "Education - Tenth Grade",
                                       "Education - Eleventh Grade",
                                       "Education - Twelfth Grade - No Diploma",
                                       "Education - High School Diploma",
                                       "Education - GED or Alternative",
                                       "Education - Less Than 1 Year College",
                                       "Education - More Than 1 Year Collage - No Degree",
                                       "Education - Associates Degree",
                                       "Education - Bachelors Degree",
                                       "Education - Masters Degree",
                                       "Education - Professional School Degree",
                                       "Education - Doctorate Degree",
                                       "Commute - Car, Truck or Van",
                                       "Commute - Drive Alone",
                                       "Commute - Carpool",
                                       "Commute - 2 Person Carpool",
                                       "Commute - 3 Person Carpool",
                                       "Commute - 4 Person Carpool",
                                       "Commute - 5 or 6 Person Carpool",
                                       "Commute - 7 or More Person Carpool",
                                       "Commute - Public Transportation",
                                       "Commute - Bus or Trolley",
                                       "Commute - Subway or Elevated Train",
                                       "Commute - Railroad Train",
                                       "Commute - Ferry Boat",
                                       "Commute - Taxi",
                                       "Commute - Motorcycle",
                                       "Commute - Bicycle",
                                       "Commute - Walk",
                                       "Commute - Other Means",
                                       "Commute - Work from Home",
                                       "Household Income - Less than $10,000",
                                       "Household Income - $10,000 - $14,999",
                                       "Household Income - $15,000 - $19,999",
                                       "Household Income - $20,000 - $24,999",
                                       "Household Income - $25,000 - $29,999",
                                       "Household Income - $30,000 - $34,999",
                                       "Household Income - $35,000 - $39,999",
                                       "Household Income - $40,000 - $44,999",
                                       "Household Income - $45,000 - $49,999",
                                       "Household Income - $50,000 - $59,999",
                                       "Household Income - $60,000 - $74,999",
                                       "Household Income - $75,000 - $99,999",
                                       "Household Income - $100,000 - $124,999",
                                       "Household Income - $125,000 - $149,999",
                                       "Household Income - $150,000 - $199,999",
                                       "Household Income - $200,000 or More",
                                       "Aggregate Income Deficit",
                                       "Aggregate Income Deficit - Married",
                                       "Aggregate Income Deficit - Nonmarried",
                                       "Aggregate Income Deficit - No Wife",
                                       "Aggregate Income Deficit - No Husband",
                                       "Commute - Streetcar or Trolley Car",
                                       "Empolyed - No Vehicles Available",
                                       "Empolyed - 1 Vehicle Available",
                                       "Empolyed - 2 Vehicles Available",
                                       "Empolyed - 3 Vehicles Available",
                                       "Empolyed - 4 Vehicles Available",
                                       "Empolyed - 5 Vehicles Available")

#Creat the data table
datatable(transposed_profile_sums,
          extensions = 'Buttons', options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)
```

#Neighborhood Block Group Data
Next, geospatial analysis is conducted to find Block Groups that overlap with the Neighborhood Resource Council's defined neighborhoods.

##Neighborhood Map
First, a map of the neighborhoods is created for reference.

```{r, echo=FALSE, message=FALSE}
#Register the google API key
#Please update if adopted by South Bend city employees, as I will be billed (Joe Kosteck)
register_google(key = "AIzaSyCWV1S0fxPTZQ1mwvIcNDdKLsz7VVqdQss")

#Get a map of South Bend (static map)
st_joes_map <- get_map("South Bend, Indiana", zoom = 12)

#Create a shapefile of the neighborhoods that can be graphed by ggmap package
neighborhoods_sf <- fortify(neighborhoods)

#Create a data.frame of the neighborhood names
neighborhood_names <- tibble("id" = as.character(0:(length(neighborhoods$Name) - 1)),
                             "Label" = as.character(1:(length(neighborhoods$Name))),
                             "Neighborhood Name" = neighborhoods$Name)

#Add the names to the neighborhood. This will be used to color them
neighborhoods_sf <- neighborhoods_sf %>%
  inner_join(neighborhood_names)

#Find the centroid of each neighborhood. This will be used to label them
neighborhood_coords <- data.frame("id" = as.character(0:(length(neighborhoods$Name) - 1)),
                                  coordinates(neighborhoods),
                                  stringsAsFactors = F)

#Set column names for graphing
colnames(neighborhood_coords) <- c("id", "lon", "lat")

#Map the neighborhoods and label them
ggmap(st_joes_map) + 
  geom_polygon(data = neighborhoods_sf,
               aes(x = long, y = lat,
                   color = `Neighborhood Name`, fill = `Neighborhood Name`,
                   alpha = 0)) +
  geom_text(data = neighborhood_coords,
            aes(label = 1:length(neighborhoods$Name), size = 1)) + 
  guides(alpha = F, fill = F, color = F, size = F) +
  theme(axis.text = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())
```

```{r, echo=FALSE}
#Display a key for the map above to identify neighborhoods
datatable(select(neighborhood_names, Label, `Neighborhood Name`),
          rownames = F,
          extensions = 'Buttons', options = list(
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)
```

##Overlapping Neighborhoods and Block Groups
Next, a table is created which lists each neighborhood, the block groups that overlap with that neighborhood, and the variables for those block groups.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Convert the SpatialPolygonsDataFram to a sf type
neighborhoods_sf <- st_as_sf(neighborhoods)

#Make sure projection is the same
neighborhoods_sf <- st_transform(neighborhoods_sf, st_crs(block_shapes_profile))

#Find which neighborhoods and block groups overlap
intersecting_neighborhoods_sf <- st_intersection(neighborhoods_sf, block_shapes_profile)

#Make into a tbille/data frame for ease of use, select only relevant names
intersecting_neighborhoods_df <- as_tibble(intersecting_neighborhoods_sf) %>%
  select(Neighborhood = Name, `Block Group` = Block.Group, `Census Tract` = Census.Tract)

#Join the block group data
intersecting_neighborhoods_df <- intersecting_neighborhoods_df %>%
  inner_join(total_block_data, by = c("Block Group", "Census Tract")) %>%
  select(-NAME, -County, -GEOID, -State)

#Set the column names that will be used.
intersecting_neighborhoods_names <- c("Neighborhood",
                                      "Block Group",
                                      "Census Tract",
                                      "Profile",
                                      "Total Population",
                                      "Total Housing Units",
                                      "Total Occupied Housing Units",
                                      "Total Vacant Housing Units",
                                      "Total Owner-Occupied Units",
                                      "Total Renter-Occupied Units",
                                      "Total Units for Rent",
                                      "Total Rented, Non-Occupied Units",
                                      "Total Units for Sale",
                                      "Total Sold, Non-Occupied Units",
                                      "25th Percentile Home Value",
                                      "50th Percentile Home Value",
                                      "75th Percentile Home Value",
                                      "Median Owner Cost - Mortgage",
                                      "Median Owner Cost - No Mortgage",
                                      "Median Owner Cost/Income - Mortgage",
                                      "Median Owner Cost/Income - No Mortgage",
                                      "Median Family Income",
                                      "Total White Population",
                                      "Total Black Population",
                                      "Total Native American Population",
                                      "Total Asian Population",
                                      "Total Pacific Islander Population",
                                      "Total Other Population",
                                      "Total Two or More Races Population",
                                      "Median Age",
                                      "Median Age - Male",
                                      "Median Age - Female",
                                      "Total Households",
                                      "Family Households",
                                      "Family Households - Married",
                                      "Family Households - Other",
                                      "Non-family Households",
                                      "Non-family Households - Alone",
                                      "Non-family Households - Not Alone",
                                      "Two Person Families",
                                      "Three Person Families",
                                      "Four Person Families",
                                      "Five Person Families",
                                      "Six Person Families",
                                      "7 or More Person Families",
                                      "1 Person Non-families",
                                      "2 Person Non-families",
                                      "3 Person Non-families",
                                      "4 Person Non-families",
                                      "5 Person Non-families",
                                      "6 Person Non-families",
                                      "7 or More Person Non-families",
                                      "Average Labor Force",
                                      "Civilian Labor Force",
                                      "Civilian Labor Force - Employed",
                                      "Civilian Labor Force - Unemployed",
                                      "Military Labor Force",
                                      "Non-Labor Force",
                                      "Education - No Schooling",
                                      "Education - Nursery School",
                                      "Education - Kindergarten",
                                      "Education - First Grade",
                                      "Education - Second Grade",
                                      "Education - Third Grade",
                                      "Education - Fourth Grade",
                                      "Education - Fifth Grade",
                                      "Education - Sixth Grade",
                                      "Education - Seventh Grade",
                                      "Education - Eighth Grade",
                                      "Education - Ninth Grade",
                                      "Education - Tenth Grade",
                                      "Education - Eleventh Grade",
                                      "Education - Twelfth Grade - No Diploma",
                                      "Education - High School Diploma",
                                      "Education - GED or Alternative",
                                      "Education - Less Than 1 Year College",
                                      "Education - More Than 1 Year Collage - No Degree",
                                      "Education - Associates Degree",
                                      "Education - Bachelors Degree",
                                      "Education - Masters Degree",
                                      "Education - Professional School Degree",
                                      "Education - Doctorate Degree",
                                      "Commute - Car, Truck or Van",
                                      "Commute - Drive Alone",
                                      "Commute - Carpool",
                                      "Commute - 2 Person Carpool",
                                      "Commute - 3 Person Carpool",
                                      "Commute - 4 Person Carpool",
                                      "Commute - 5 or 6 Person Carpool",
                                      "Commute - 7 or More Person Carpool",
                                      "Commute - Public Transportation",
                                      "Commute - Bus or Trolley",
                                      "Commute - Subway or Elevated Train",
                                      "Commute - Railroad Train",
                                      "Commute - Ferry Boat",
                                      "Commute - Taxi",
                                      "Commute - Motorcycle",
                                      "Commute - Bicycle",
                                      "Commute - Walk",
                                      "Commute - Other Means",
                                      "Commute - Work from Home",
                                      "Household Income - Less than $10,000",
                                      "Household Income - $10,000 - $14,999",
                                      "Household Income - $15,000 - $19,999",
                                      "Household Income - $20,000 - $24,999",
                                      "Household Income - $25,000 - $29,999",
                                      "Household Income - $30,000 - $34,999",
                                      "Household Income - $35,000 - $39,999",
                                      "Household Income - $40,000 - $44,999",
                                      "Household Income - $45,000 - $49,999",
                                      "Household Income - $50,000 - $59,999",
                                      "Household Income - $60,000 - $74,999",
                                      "Household Income - $75,000 - $99,999",
                                      "Household Income - $100,000 - $124,999",
                                      "Household Income - $125,000 - $149,999",
                                      "Household Income - $150,000 - $199,999",
                                      "Household Income - $200,000 or More",
                                      "Median Rent/Income",
                                      "Median Housing Cost",
                                      "Median Non-family Income",
                                      "Median Rent - No Bedrooms",
                                      "Median Rent - 1 Bedroom",
                                      "Median Rent - 2 Bedrooms",
                                      "Median Rent - 3 Bedrooms",
                                      "Median Rent - 4 Bedrooms",
                                      "Median Rent - 5 or More Bedrooms",
                                      "Median Rent",
                                      "Aggregate Income Deficit",
                                      "Aggregate Income Deficit - Married",
                                      "Aggregate Income Deficit - Nonmarried",
                                      "Aggregate Income Deficit - No Wife",
                                      "Aggregate Income Deficit - No Husband",
                                      "Median Household Income",
                                      "Median Household Income - Owners",
                                      "Median Household Income - Renters",
                                      "Commute - Streetcar or Trolley Car",
                                      "Empolyed - No Vehicles Available",
                                      "Empolyed - 1 Vehicle Available",
                                      "Empolyed - 2 Vehicles Available",
                                      "Empolyed - 3 Vehicles Available",
                                      "Empolyed - 4 Vehicles Available",
                                      "Empolyed - 5 Vehicles Available")

#Make the column names human readable
colnames(intersecting_neighborhoods_df) <- intersecting_neighborhoods_names

#Finally, make the data table
datatable(intersecting_neighborhoods_df,
          rownames = F,
          extensions = 'Buttons',
          options = list(
            scrollX = T,
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)
```

##Average Values for Overlapping Neighborhoods and Block Groups
Below, a table is created that shows the average values of the block groups that touch each neighborhood.
```{r, echo=FALSE, warning=FALSE}
#Group the data from above, then summarize by taking the mean
#Transpose the data to make it look better in table form
neighborhood_transposed <- intersecting_neighborhoods_df %>%
  group_by(Neighborhood) %>%
  select_if(is.numeric) %>%
  select(-Profile) %>%
  summarise_all(mean, na.rm = T) %>%
  t(.) %>%
  as.tibble()

#Set the neighborhoods as the column names
colnames(neighborhood_transposed) <- neighborhood_transposed[1, ]

#Get rid of the row of neighborhood names
neighborhood_transposed <- neighborhood_transposed[-1, ]

#Make everything numeric and round all values
neighborhood_transposed <- neighborhood_transposed %>%
  mutate_all(as.numeric) %>%
  round(., 3)

#Get the row names from the above data frame, replace Total with Average
neighborhood_row_names <- str_replace_all(colnames(intersecting_neighborhoods_df)[-c(1:4)],
                                          "Total",
                                          "Average")

#Make the row names a column here
neighborhood_transposed$rowname <- neighborhood_row_names

#Make them actually the row names now
neighborhood_transposed <- column_to_rownames(neighborhood_transposed, var = "rowname")

#Creat the data table
datatable(neighborhood_transposed,
          extensions = 'Buttons',
          options = list(
            scrollX = T,
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)
```

#Individual Profiles
This section will dive deeper into each individual profile.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Join the spatial data and the block group variable data
block_shapes_data <- block_shapes_profile %>%
  inner_join(total_block_data)

#create another popup with key statistics
block_shapes_data$data_popup <- paste0("<b>Census Tract: </b>",
                                       block_shapes_data$`Census Tract`,
                                       "<br><b>Block Group: </b>",
                                       block_shapes_data$`Block Group`,
                                       "<br>Population: ",
                                       block_shapes_data$total_populationE,
                                       "<br>Rental Units: ",
                                       block_shapes_data$total_rent_occ_unitsE,
                                       "<br>Owned Units: ",
                                       block_shapes_data$total_own_occ_unitsE,
                                       "<br>Median Home Value: ",
                                       block_shapes_data$owner_hous_val_50th_perE,
                                       "<br>Median Family Income: ",
                                       block_shapes_data$med_fam_incomeE,
                                       "<br>Median Age: ",
                                       block_shapes_data$median_ageE)
```

##Profile 1
Below is a map of profile 1. A few key statistics for each block group are shown when that block group is clicked.

```{r, warning=FALSE, echo=FALSE}
#Create leaflet map. Similar to first map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = city_limits,
              color = "black",
              fillOpacity = 0,
              opacity = 1,
              weight = 2,
              group = "City Limits") %>%
  addPolygons(data = block_shapes_data[block_shapes_data$Profile == 1,],
              color = profile_colors[1],
              fillOpacity = .75,
              opacity = 1,
              popup = ~data_popup,
              group = "Profile 1",
              label = ~paste0("Block Group ", `Block Group`, ", Tract ", `Census Tract`))
```

Relative to St. Joseph County, Profile 1 is characterized by:

*	Higher home values ($134k vs $106k)
*	Higher home ownership costs with a mortgage ($1,046 vs $972)
*	Lower family household incomes ($44k vs $62k)
*	Slightly lower rental costs ($720 vs $773)
*	Younger age (33.4 years vs 38.5 years)
*	Lower number of people per housing unit (1.5 vs 2.3)
*	Lower percentage of occupied housing units (76% vs 87%)
*	Much lower percentage of owner-occupied housing units (15% vs 59%)
*	Much higher percentage of renter-occupied housing units (61% vs 28%)
*	Much lower percentage of family households (40% vs 64%)
*	Higher labor force participation rate (55% vs 50%)

Notable Block Groups:

Block Group 2, Census Tract 115.05 is the best representation of Profile 1 due to a low median age (30.5 years), higher home values ($162,800 median home value), and the percentage of family households (40% of family households).

Block Group 3, Census Tract 113.01 the most distinct block group of Profile 1 due to a very low median age (25.7 years), a low number of people per housing unit (.98), a very low percentage of family households (19%) and higher rental costs ($883). 

##Profile 2

```{r, warning=FALSE, echo=FALSE}
#Create leaflet map. Similar to first map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = city_limits,
              color = "black",
              fillOpacity = 0,
              opacity = 1,
              weight = 2,
              group = "City Limits") %>%
  addPolygons(data = block_shapes_data[block_shapes_data$Profile == 2,],
              color = profile_colors[2],
              fillOpacity = .75,
              opacity = 1,
              popup = ~data_popup,
              group = "Profile 2",
              label = ~paste0("Block Group ", `Block Group`, ", Tract ", `Census Tract`))
```


Relative to St. Joseph County, Profile 2 is characterized by:

*	Much higher home values ($370k vs $106k)
*	Much higher home ownership costs with a mortgage ($1,758 vs $972)
*	Much higher home ownership costs without a mortgage ($524 vs $349)
*	Much higher family incomes ($134k vs $62k)
*	Much higher rent ($1,020 vs $773)
*	Slightly older age (41.0 years vs 38.5 years)
*	Much higher people per housing unit (4.1 vs 2.3)
*	Higher percentage of occupied housing units (95% vs 87%)
*	Much higher percentage of owner-occupied housing units (91% vs 59%)
*	Much lower percentage of renter-occupied housing units (5% vs 28%)
*	Lower percentage of Black residents (4% vs 13%)
*	Higher percentage of Asian residents (9% vs 2%)
*	Much higher percentage of family households (81% vs 64%)
*	Higher percentage of people not in the labor force (36% vs 29%)

Based on these observations, Profile 2 can be described as block groups with higher home values, more people per home, and whose inhabitants own their own homes, have higher incomes, and tend to have families. 

Notable Block Groups:

Block Group 1, Census Tract 113.04 is the best representation of Profile 2 due to a higher median family income ($121,616), a higher percentage of owner-occupied housing units (94%), a higher percentage of family households (78.8%), and its higher median age (49.2 years old).

Block Group 1, Census Tract 113.05 is the most distinct block group of Profile 2 due to a lower median home value ($199,700), lower median family income ($120,179), and a higher percentage of family households (86%). 

##Profile 3

```{r, warning=FALSE, echo=FALSE}
#Create leaflet map. Similar to first map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = city_limits,
              color = "black",
              fillOpacity = 0,
              opacity = 1,
              weight = 2,
              group = "City Limits") %>%
  addPolygons(data = block_shapes_data[block_shapes_data$Profile == 3,],
              color = profile_colors[3],
              fillOpacity = .75,
              opacity = 1,
              popup = ~data_popup,
              group = "Profile 3",
              label = ~paste0("Block Group ", `Block Group`, ", Tract ", `Census Tract`))
```

Relative to St. Joseph County, Profile 3 is characterized by:

*	Slightly older age (41.4 years vs 38.5 years)
*	Slightly higher percentage of owner-occupied housing units (68% vs 59%)
*	Slightly lower percentage of renter-occupied housing units (19% vs 28%)
*	Higher percentage of White residents (87% vs 79%)
*	Lower percentage of Black residents (7% vs 13%)

Based on these observations, Profile 3 can be described as block groups that are representative of St. Joseph County as a whole, albeit with a slightly older population that is more likely to own their homes and has a higher proportion of White residents. 

Notable Block Groups:

Block Group 1, Census Tract 12 is best representative of Profile 3 due to due to a higher median home value ($120,100), a median family income ($64,500) consistent with the rest of Profile 3, percentage of owner-occupied homes (91%), percentage of White residents (86%), and percentage of family households (64%).

Block Group 3, Census Tract 10 is a distinct block group in Profile 3 due to lower home values (median value of $33,000), higher rental costs ($904), a lower percentage of owner-occupied housing units (11%), and a lower percentage of family households (14%), and a lower percentage of White people (77%).

Block Group 1, Census Tract 7 is a distinct block group in Profile 3 due to lower home values (median home value of $73,600), a lower median age (34.8 years), a higher percentage of Black residents, and a higher percentage of vacant units (21%). 


##Profile 4
```{r, warning=FALSE, echo=FALSE}
#Create leaflet map. Similar to first map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = city_limits,
              color = "black",
              fillOpacity = 0,
              opacity = 1,
              weight = 2,
              group = "City Limits") %>%
  addPolygons(data = block_shapes_data[block_shapes_data$Profile == 4,],
              color = profile_colors[4],
              fillOpacity = .75,
              opacity = 1,
              popup = ~data_popup,
              group = "Profile 4",
              label = ~paste0("Block Group ", `Block Group`, ", Tract ", `Census Tract`))
```

Relative to St. Joseph County, Profile 4 is characterized by:

*	Much lower home values ($69k vs $106k)
*	Lower home ownership costs with a mortgage ($817 vs $972)
*	Lower rental costs ($728 vs $773)
*	Much lower family incomes ($40k vs $61k)
*	Much younger age (32.5 years vs 38.5 years)
*	Lower percentage of owner-occupied housing units (45% vs 59%)
*	Higher percentage of renter-occupied housing units (38% vs 28%)
*	Lower percentage of White residents (62% vs 79%)
*	Higher percentage of Black residents (27% vs 13%)
*	Higher unemployment rate (10% vs 6%)

Based on these observations, Profile 4 can be described as block groups with lower home values, lower home ownership costs with a mortgage, slightly lower rental costs, and much lower family incomes. The population of Profile 4 tends to be younger, contains a higher percentage of Black residents, a lower percentage of White residents, and is more likely to be unemployed. 

Notable Block Groups:

Block Group 1, Census Tract 29 is best representative in Profile 4 due to lower home values (median home value of $54,600), lower rental costs ($658), a lower median age (29.1), a lower percentage of occupied housing units (77.9%), a high unemployment rate (89%). However, this block group is not representative of Profile 4 due to its higher percentage of families (82%) and a very high percentage of Black people (52%).

Block Group 1, Census Tract 27 is an extreme representation of Profile 4 due to a lower median age (30.2 years), lower home values (median home value of $41,200), lower family incomes ($32,0310, a lower percentage of occupied housing units (43%), a high unemployment rate (18%). This block group also has a higher percentage of family households (72%) and a higher rental costs ($754).

Block Group 3, Census Tract 34 is an extreme representation of Profile 4 due to a lower median home value ($51,700), lower rental costs ($711), a lower percentage of occupied housing units (65%), a higher percentage of Black people (32%). This block group also skews older (39.2 years) and has a higher percentage of families (84%).

Block Group 4, Census Tract 22 is a distinct block group in Profile 4 due to a lower median home value ($42,000), a much lower median age (19.8 years), much higher rental costs ($977), a lower percentage of White people (46%), and a higher percentage of family households (84%). This block group also has an occupied-housing rate of 88% and a median family income of $42,083.

Block Group 1, Census Tract 26 is notable or having home values that are lower than the Profile 4 average (median home value of $60,200) yet has higher median rents ($834), has a very low median age (19.7 years), has a lower percentage of White residents (46%), and contains more families than Profile 4 does on average (73%).


#Profile 5
```{r, warning=FALSE, echo=FALSE}
#Create leaflet map. Similar to first map
leaflet() %>%
  addTiles() %>%
  addPolygons(data = city_limits,
              color = "black",
              fillOpacity = 0,
              opacity = 1,
              weight = 2,
              group = "City Limits") %>%
  addPolygons(data = block_shapes_data[block_shapes_data$Profile == 5,],
              color = profile_colors[5],
              fillOpacity = .75,
              opacity = 1,
              popup = ~data_popup,
              group = "Profile 5",
              label = ~paste0("Block Group ", `Block Group`, ", Tract ", `Census Tract`))
```

Relative to St. Joseph County, Profile 5 is characterized by:

*	Higher home values ($151k vs $106k)
*	Higher home ownership costs with a mortgage ($1,142 vs $972)
*	Higher rental costs ($954 vs $773)
*	Older age (43.6 years vs 38.5 years)
*	Slightly higher number of people per housing unit (2.6 vs 2.3)
*	Higher percentage of occupied housing units (97% vs 87%)
*	Much higher percentage of owner-occupied housing units (84% vs 59%)
*	Lower percentage of renter-occupied housing units (14% vs 28%)
*	Much higher percentage of White residents (91% vs 79%)
*	Higher percentage of family households (74% vs 64%)

Based on these observations, Profile 4 can be described as block groups with higher home values and correspondingly higher home ownership costs with a mortgage, higher rental costs, and slightly more occupants per home whose inhabitants are more likely to own their homes. The population of Profile 5 tends to be older, with higher proportion of White residents, and a higher percentage of family households. 

Notable Block Groups:

Block Group 2, Census Tract 113.05 is representative of Profile 5 due to a higher median home value ($146,300), higher rental costs ($1,304), an older median age (44 years), more people per housing unit (2.66), a higher percentage of white people (85%), and a higher percentage of family households (75%).

Block Group 4, Census Tract 109 is an extreme representation of Profile 5 due to a higher median home value ($177,700), higher median age (46.3 years), and a higher percentage of owner-occupied housing units (91%). 


#City and County Comparison
This section will find block groups that overlap with the city limits and those that do not. The average values of the variables will be shown for in-city and out-city block groups, as well as the county as a whole.
```{r, echo=FALSE, warning=FALSE, message=FALSE}
#Convert city shapefile from SpatialPolygonsDataFrame to sf file
city_limits_sf <- st_as_sf(city_limits)

#Make sure the projection is the same
city_limits_sf <- st_transform(city_limits_sf, st_crs(block_shapes_profile))

#Find which block groups overlap with the city
intersecting_city_limits_sf <- st_intersection(city_limits_sf, block_shapes_profile)

#Make that a dataframe
intersecting_city_limits_df <- as_tibble(intersecting_city_limits_sf) %>%
  select(NAME, `Block Group` = Block.Group, `Census Tract` = Census.Tract) %>%
  mutate(Region = "In-City")

#Join the total data to the intersecting
intersecting_city_limits_df <- intersecting_city_limits_df %>%
  right_join(total_block_data, by = c("NAME", "Block Group", "Census Tract"))

#For block groups that were not matched (in the intersecting dataframe), set
#the region as out of city
intersecting_city_limits_df$Region[is.na(intersecting_city_limits_df$Region)] <- "Out-City"

#Add another copy of the total data
#This time, make the region = "County"
intersecting_city_limits_df <- bind_rows(intersecting_city_limits_df, total_block_data)
intersecting_city_limits_df$Region[is.na(intersecting_city_limits_df$Region)] <- "County"

#Drop the unneeded variables
intersecting_city_limits_df <- intersecting_city_limits_df %>%
  select(-NAME, -State, -County, -GEOID)

#The column names here are the similar as before, reuse variable
city_limits_names <- intersecting_neighborhoods_names
city_limits_names[1:3] <- c("Block Group", "Census Tract", "Region")

#Set the column names
colnames(intersecting_city_limits_df) <- city_limits_names

#Transpose the data, summarize it by taking the mean, transpose for looks
city_limits_transposed <- intersecting_city_limits_df %>%
  group_by(Region) %>%
  select_if(is.numeric) %>%
  select(-Profile) %>%
  summarise_all(mean, na.rm = T) %>%
  t(.) %>%
  as.tibble()

#Set the column names as the region
colnames(city_limits_transposed) <- city_limits_transposed[1, ]

#Drop the region row
city_limits_transposed <- city_limits_transposed[-1, ]

#Make each column numeric, and round them
city_limits_transposed <- city_limits_transposed %>%
  mutate_all(as.numeric) %>%
  round(., 3)

#Make the row names a column here, reuse from above
city_limits_transposed$rowname <- neighborhood_row_names

#Make them actually the row names now
city_limits_transposed <- column_to_rownames(city_limits_transposed, var = "rowname")

#Create the table
datatable(city_limits_transposed,
          extensions = 'Buttons',
          options = list(
            scrollX = T,
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')
          )
)

```